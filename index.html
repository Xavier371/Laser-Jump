<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Laser Jump</title>
  <style>
    :root{
      --canvas-size-portrait: 96vmin;   /* full but safe in portrait (mobile) */
      --canvas-size-landscape: 86vmin;  /* smaller in landscape, centered (mobile) */

      --jump-w: 21vmin;
      --jump-h: 10.5vmin;

      /* Theme (xaviermathgames-like blue) */
      --brand-blue: #0033a0;
      --brand-blue-dark: #0b2a7a;
      --brand-blue-soft: rgba(0,51,160,0.08);
      --brand-border: rgba(0,0,0,0.18);
    }

    html, body {
      width: 100%; height: 100%;
      margin: 0; padding: 0;
      overflow: hidden; background: #f0f0f0;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      display: flex; justify-content: center; align-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* ===== Layout wrapper ===== */
    #game-enclosure {
      width: 100%;
      max-width: 820px;
      display: flex; flex-direction: column;
      align-items: center; gap: 8px;
      position: relative;
    }

    /* ===== Title ===== */
    h1 {
      margin: 8px 0 4px 0;
      font-size: 24px; line-height: 1.2;
      text-align: center;
      width: 100%;
      color: #111;
      z-index: 6;
    }

    /* ===== Controls ===== */
    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: 560px;
      padding: 0 8px;
      z-index: 6;
    }
    .btn {
      border: 1px solid var(--brand-blue);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      background: var(--brand-blue);
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform .05s ease, background .15s ease;
      white-space: nowrap;
      display: inline-block;
    }
    .btn:hover { background: var(--brand-blue-dark); }
    .btn:active { transform: translateY(1px); background: var(--brand-blue-dark); }

    /* ===== Canvas (default / desktop) ===== */
    canvas {
      display: block; margin: 0 auto;
      width: var(--canvas-size-portrait);
      height: var(--canvas-size-portrait);
      max-width: 580px; max-height: 580px;
      border: 2px solid #000; background: #fff;
      touch-action: none;
      z-index: 1;
    }

    /* Desktop: make grid a little smaller and lift content a bit */
    @media (hover:hover) and (pointer:fine){
      canvas{
        width: 78vmin;
        height: 78vmin;
        max-width: 480px;
        max-height: 480px;
      }
      #game-enclosure{
        transform: translateY(-3.2vh); /* move title+buttons a little higher */
      }
    }

    /* ===== Portrait (mobile vertical) ===== */
    @media (hover:none) and (pointer:coarse) and (orientation:portrait) {
      /* Title centered at the top */
      h1 { position: fixed; top: 6px; left: 0; right: 0; }
      /* Buttons: small & side-by-side directly under title, moved down a bit */
      .controls {
        position: fixed;
        top: 56px; /* sits between title & grid */
        left: 0; right: 0;
        justify-content: center;
        gap: 6px;
      }
      .btn { font-size: 12.5px; padding: 5px 8px; }

      /* Jump: to the left under the grid & bigger, but stay off the grid and on screen */
      #jumpArea {
        position: fixed;
        left: calc(50% - var(--canvas-size-portrait) / 2 + 6vw);
        top: calc(50% + var(--canvas-size-portrait) / 2 + 3.2vh);
        width: min(calc(var(--jump-w) * 1.50), 42vw);  /* bigger but capped */
        height: calc(var(--jump-h) * 1.50);
        max-height: 14vh;
        transform: none;
        min-width: 112px;
        min-height: 62px;
      }
    }

    /* ===== Landscape (mobile horizontal) ===== */
    @media (hover:none) and (pointer:coarse) and (orientation:landscape) {
      body { align-items: stretch; }
      #game-enclosure { height: 100%; max-width: none; }

      /* Title top-left */
      h1 {
        position: fixed;
        top: 6px; left: 10px; right: auto;
        text-align: left;
      }

      /* Buttons top-right (stacked), natural width, centered in their column */
      .controls {
        position: fixed;
        top: 6px; right: 10px; left: auto;
        width: auto;                 /* natural width */
        flex-direction: column;
        gap: 6px;
        justify-content: center;     /* center within column vertically */
        align-items: center;         /* center buttons horizontally in column */
      }
      .btn {
        font-size: 12px;
        padding: 4px 8px;            /* compact */
      }

      /* Grid smaller and centered */
      canvas{
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: var(--canvas-size-landscape);
        height: var(--canvas-size-landscape);
        max-width: none; max-height: none;
        z-index: 1;
      }

      /* Jump bottom-left, a touch bigger (but not huge) */
      #jumpArea {
        position: fixed;
        left: 2vw; bottom: 3vh;
        transform: none;
        width: min(calc(var(--jump-w) * 1.30), 28vw);
        height: calc(var(--jump-h) * 1.30);
        max-height: 16vh;
        min-width: 104px;
        min-height: 58px;
      }
    }

    /* ===== Modal ===== */
    #instructionsModal {
      display:none; position:fixed; z-index:7; inset:0; background:rgba(0,0,0,0.4);
    }
    .modal-content {
      background:#fff; margin:12% auto; padding:20px; border:1px solid #888;
      width:80%; max-width:500px; border-radius:10px; position:relative;
    }
    #closeButton { position:absolute; right:12px; top:8px; font-size:24px; cursor:pointer; }

    /* ===== Mobile Touch UI ===== */
    .touch-ui { display: none; }
    @media (hover:none) and (pointer:coarse){
      .touch-ui{ display:block; }

      /* Base jump button (size overridden in media blocks) */
      #jumpArea{
        z-index: 5; touch-action: none; box-sizing: border-box;
        width: calc(var(--jump-w) * 1.2);
        height: calc(var(--jump-h) * 1.2);
        min-width: 90px; min-height: 50px;
        border: 2px solid var(--brand-border);
        border-radius: 12px; background: var(--brand-blue-soft);
      }

      /* Right-side joystick input zone â€“ under header/buttons */
      #joystickArea{
        position: fixed; right: 0; top: 0; bottom: 0;
        width: 48vw; max-width: 560px;
        z-index: 3; /* under header/buttons which are z-index:6 */
        touch-action: none; background: transparent;
      }

      /* Joystick visuals (home + dynamic) */
      #joyHomeBase, #joyHomeStick, #joyDynBase, #joyDynStick{
        position: fixed; border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none; z-index: 4;
      }
      #joyHomeBase{
        width: 24vmin; height: 24vmin; max-width: 200px; max-height: 200px;
        border: 2px solid var(--brand-border); background: rgba(0,0,0,0.04);
        display: none;
      }
      #joyHomeStick{
        width: 11vmin; height: 11vmin; max-width: 95px; max-height: 95px;
        border: 2px solid rgba(0,0,0,0.22); background: rgba(0,0,0,0.10);
        display: none;
      }
      #joyDynBase{
        width: 24vmin; height: 24vmin; max-width: 200px; max-height: 200px;
        border: 2px solid var(--brand-border); background: rgba(0,0,0,0.04);
        display: none;
      }
      #joyDynStick{
        width: 11vmin; height: 11vmin; max-width: 95px; max-height: 95px;
        border: 2px solid rgba(0,0,0,0.22); background: rgba(0,0,0,0.10);
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="game-enclosure">
    <h1>Laser Jump</h1>

    <!-- Buttons (portrait: side-by-side; landscape: vertical top-right) -->
    <div class="controls" id="controls">
      <button class="btn" id="restartButton">Restart</button>
      <button class="btn" id="instructionsButton">Instructions</button>
      <button class="btn" id="difficultyButton">Mode: Hard</button>
    </div>

    <canvas id="gameCanvas" width="500" height="500"></canvas>
  </div>

  <!-- Mobile overlays -->
  <div class="touch-ui" id="jumpArea" aria-label="Jump"></div>
  <div class="touch-ui" id="joystickArea" aria-label="Joystick area"></div>
  <!-- Home joystick (fixed bottom-right corner) -->
  <div class="touch-ui" id="joyHomeBase"></div>
  <div class="touch-ui" id="joyHomeStick"></div>
  <!-- Dynamic joystick (appears at touch) -->
  <div class="touch-ui" id="joyDynBase"></div>
  <div class="touch-ui" id="joyDynStick"></div>

  <!-- Instructions -->
  <div id="instructionsModal">
    <div class="modal-content">
      <span id="closeButton">&times;</span>
      <h2>How to Play</h2>
      <ul>
        <li>Desktop: arrow keys to move, Space to jump.</li>
        <li>Mobile: joystick to move, button to jump. </li>
        <li>Collect coins to score, teleport through walls, avoid lasers.</li>
      </ul>
    </div>
  </div>

<script>
/* ===== Core Game Setup ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const restartButton = document.getElementById('restartButton');
const instructionsButton = document.getElementById('instructionsButton');
const difficultyButton = document.getElementById('difficultyButton');
const instructionsModal = document.getElementById('instructionsModal');
const closeButton = document.getElementById('closeButton');
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

const gameResolution = 500;
const gridSize = 25;
canvas.width = canvas.height = gameResolution;

let player = {
  x: gameResolution/2, y: gameResolution/2,
  radius: gridSize/2,
  speed: isMobile ? 6.8 : 2.6,   // a bit faster on phones, a little slower on computers
  vx: 0, vy: 0,
  color: 'blue',
  isJumping: false,
  jumpStartTime: 0,
  jumpDuration: 500,
};
let lasers = [];
let coin = { x: 0, y: 0, radius: gridSize/2, color: 'gold' };
let score = 0, gameOver = false, paused = false, hardMode = true;
const keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };

/* Laser speed tuning: slower on desktop, faster on mobile */
const LASER_SPEED = isMobile ? 2.6 : 1.8;

/* Reset & start */
function resetGame(){
  player.x = gameResolution/2; player.y = gameResolution/2;
  player.vx = player.vy = 0; player.isJumping = false; player.color = 'blue';
  lasers = [
    { y: 50, vy: LASER_SPEED, height: 5, color: 'red' },
    { x: 50, vx: LASER_SPEED, width: 5,  color: 'red' }
  ];
  score = 0; gameOver = false; paused = false;
  spawnCoin();
}
function startGame(){ update(); }
function runCountdown(){
  let count = 3;
  (function tick(){
    draw();
    if (count>0){
      ctx.fillStyle='black'; ctx.font='100px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(count, canvas.width/2, canvas.height/2);
      count--; setTimeout(tick,700);
    } else { ctx.textBaseline='alphabetic'; startGame(); }
  })();
}

/* Buttons */
restartButton.addEventListener('click', ()=>{ resetGame(); startGame(); });
difficultyButton.addEventListener('click', ()=>{
  hardMode = !hardMode;
  difficultyButton.textContent = `Mode: ${hardMode ? 'Hard' : 'Easy'}`;
});
instructionsButton.addEventListener('click', ()=>{ paused=true; instructionsModal.style.display='block'; });
closeButton?.addEventListener('click', ()=>{ instructionsModal.style.display='none'; if (paused){ paused=false; update(); } });
window.addEventListener('click', (e)=>{ if (e.target===instructionsModal){ instructionsModal.style.display='none'; if (paused){ paused=false; update(); } } });

/* Coin */
function spawnCoin(){
  const pad = coin.radius*2;
  coin.x = pad + Math.random()*(canvas.width - 2*pad);
  coin.y = pad + Math.random()*(canvas.height - 2*pad);
}

/* Keyboard */
document.addEventListener('keydown', e=>{
  if (gameOver && e.key==='Enter'){ resetGame(); startGame(); return; }
  if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
  if ((e.key===' '||e.key==='Spacebar') && !player.isJumping){
    player.isJumping = true; player.jumpStartTime = Date.now(); player.color='lightblue';
  }
});
document.addEventListener('keyup', e=>{ if (keys.hasOwnProperty(e.key)) keys[e.key] = false; });

/* ===== Mobile Touch Controls ===== */
const jumpArea = document.getElementById('jumpArea');
const joystickArea = document.getElementById('joystickArea');

/* Home joystick (always visible at bottom-right until drag) */
const joyHomeBase  = document.getElementById('joyHomeBase');
const joyHomeStick = document.getElementById('joyHomeStick');

/* Dynamic joystick (appears at drag point) */
const joyDynBase  = document.getElementById('joyDynBase');
const joyDynStick = document.getElementById('joyDynStick');

let joyActive = false;
let joyId = null;
let joyCenter = { x: 0, y: 0 };
let joyMax = 100;                      // deflection radius
let joyTargetVx = 0, joyTargetVy = 0;  // target velocity; eased toward

/* Place the "home" joystick fixed in bottom-right corner, accounting for its size */
function placeHomeJoystick(){
  // Temporarily reveal to measure size so it sits fully on-screen
  joyHomeBase.style.visibility = 'hidden';
  joyHomeStick.style.visibility = 'hidden';
  joyHomeBase.style.display = 'block';
  joyHomeStick.style.display = 'block';

  const br = joyHomeBase.getBoundingClientRect();
  const halfW = br.width / 2;
  const halfH = br.height / 2;

  const marginX = Math.max(14, window.innerWidth * 0.02);
  const marginY = Math.max(16, window.innerHeight * 0.03);

  const baseX = window.innerWidth  - marginX - halfW;
  const baseY = window.innerHeight - marginY - halfH;

  joyHomeBase.style.left  = baseX + 'px';
  joyHomeBase.style.top   = baseY + 'px';
  joyHomeStick.style.left = baseX + 'px';
  joyHomeStick.style.top  = baseY + 'px';

  // Show for real
  joyHomeBase.style.visibility = 'visible';
  joyHomeStick.style.visibility = 'visible';
}

/* Adjust joystick scale with viewport */
function adjustJoyMax(){
  const unit = Math.min(window.innerWidth, window.innerHeight);
  joyMax = Math.max(80, Math.min(130, unit * 0.12));
}
function onResize(){
  adjustJoyMax();
  if (isMobile) placeHomeJoystick();
}
window.addEventListener('resize', onResize);
if (isMobile) onResize();

/* Jump helper */
function triggerJump(){
  if (gameOver || paused) return;
  if (!player.isJumping){
    player.isJumping = true; player.jumpStartTime = Date.now(); player.color='lightblue';
    if (navigator.vibrate) navigator.vibrate(10);
  }
}

/* Jump button direct touch */
if (isMobile){
  jumpArea.addEventListener('touchstart', (e)=>{
    triggerJump();
    e.preventDefault();
  }, {passive:false});
}

/* Tap-near-jump proximity on mobile (kept as-is) */
if (isMobile){
  document.addEventListener('touchstart', (e)=>{
    const t = e.changedTouches[0];
    if (!t) return;

    // Ignore touches starting in the joystick area
    const jRect = joystickArea.getBoundingClientRect();
    if (t.clientX >= jRect.left && t.clientX <= jRect.right &&
        t.clientY >= jRect.top  && t.clientY <= jRect.bottom){
      return;
    }

    // Proximity to jump button
    const r = jumpArea.getBoundingClientRect();
    const unit = Math.min(window.innerWidth, window.innerHeight);
    const margin = Math.max(30, Math.min(80, unit * 0.06)); // generous radius
    const near =
      t.clientX >= (r.left - margin)  && t.clientX <= (r.right + margin) &&
      t.clientY >= (r.top  - margin)  && t.clientY <= (r.bottom + margin);

    if (near){
      triggerJump();
      e.preventDefault();
    }
  }, {passive:false});
}

/* Dynamic joystick lifecycle */
function showDynamicJoystick(cx, cy){
  joyCenter.x = cx; joyCenter.y = cy;
  joyDynBase.style.left  = cx + 'px';
  joyDynBase.style.top   = cy + 'px';
  joyDynStick.style.left = cx + 'px';
  joyDynStick.style.top  = cy + 'px';
  joyDynBase.style.display = 'block';
  joyDynStick.style.display = 'block';
}
function hideDynamicJoystick(){
  joyDynBase.style.display = 'none';
  joyDynStick.style.display = 'none';
}
function hideHomeJoystick(){
  joyHomeBase.style.display = 'none';
  joyHomeStick.style.display = 'none';
}

/* Right-side area touch handling (buttons are above thanks to higher z-index) */
if (isMobile){
  joystickArea.addEventListener('touchstart', e=>{
    if (gameOver || paused) return;
    const t = e.changedTouches[0];
    joyId = t.identifier; joyActive = true;

    hideHomeJoystick();                 // hide home joystick during drag
    showDynamicJoystick(t.clientX, t.clientY); // show dynamic at touch point
    updateStick(t.clientX, t.clientY);
    e.preventDefault();
  }, {passive:false});

  joystickArea.addEventListener('touchmove', e=>{
    if (!joyActive) return;
    let t = null;
    for (let i=0;i<e.changedTouches.length;i++){
      if (e.changedTouches[i].identifier === joyId){ t = e.changedTouches[i]; break; }
    }
    if (!t) return;
    updateStick(t.clientX, t.clientY);
    e.preventDefault();
  }, {passive:false});

  function endJoystick(e){
    if (!joyActive) return;
    let ended = false;
    for (let i=0;i<e.changedTouches.length;i++){
      if (e.changedTouches[i].identifier === joyId){ ended = true; break; }
    }
    if (ended){
      joyActive = false; joyId = null;
      joyTargetVx = 0; joyTargetVy = 0;
      hideDynamicJoystick();
      placeHomeJoystick(); // show home joystick again (bottom-right)
      e.preventDefault();
    }
  }
  joystickArea.addEventListener('touchend', endJoystick, {passive:false});
  joystickArea.addEventListener('touchcancel', endJoystick, {passive:false});
}

/* Update dynamic stick & target velocity */
function updateStick(cx, cy){
  const dx = cx - joyCenter.x;
  const dy = cy - joyCenter.y;
  const mag = Math.hypot(dx, dy);
  const capped = Math.min(mag, joyMax);
  const ux = mag ? dx/mag : 0;
  const uy = mag ? dy/mag : 0;

  joyDynStick.style.left = (joyCenter.x + ux * capped) + 'px';
  joyDynStick.style.top  = (joyCenter.y + uy * capped) + 'px';

  const speedFactor = capped / joyMax;               // 0..1
  theSpeed = player.speed * (0.28 + 0.72 * speedFactor);
  joyTargetVx = ux * theSpeed;
  joyTargetVy = uy * theSpeed;
}

/* ===== Game loop ===== */
function checkCollisions(){
  const dx = player.x - coin.x, dy = player.y - coin.y;
  if (Math.hypot(dx,dy) < player.radius + coin.radius){
    score++; spawnCoin();
    if (hardMode){
      if (score % 2){
        lasers.push({ y: player.y < canvas.height/2 ? canvas.height - 5 : 0,
                      vy: LASER_SPEED * (Math.random() > 0.5 ? 1 : -1), height: 5, color: 'red' });
      } else {
        lasers.push({ x: player.x < canvas.width/2 ? canvas.width - 5 : 0,
                      vx: LASER_SPEED * (Math.random() > 0.5 ? 1 : -1), width: 5, color: 'red' });
      }
    }
  }
  if (player.isJumping) return;

  for (const l of lasers){
    if (l.vy !== undefined){
      if (player.y + player.radius > l.y && player.y - player.radius < l.y + l.height){ gameOver = true; break; }
    } else {
      if (player.x + player.radius > l.x && player.x - player.radius < l.x + l.width){ gameOver = true; break; }
    }
  }
}

function update(){
  if (paused) return;
  if (gameOver){
    ctx.fillStyle='black'; ctx.font='40px Arial'; ctx.textAlign='center';
    ctx.fillText('Game Over', canvas.width/2, canvas.height/2);
    return;
  }
  requestAnimationFrame(update);

  // Keyboard movement
  if (keys.ArrowUp)    player.y -= player.speed;
  if (keys.ArrowDown)  player.y += player.speed;
  if (keys.ArrowLeft)  player.x -= player.speed;
  if (keys.ArrowRight) player.x += player.speed;

  // Joystick smoothing (mobile)
  if (isMobile){
    const ease = 0.22; // 0.15 smoother, 0.30 snappier
    player.vx = player.vx * (1 - ease) + joyTargetVx * ease;
    player.vy = player.vy * (1 - ease) + joyTargetVy * ease;
    player.x += player.vx;
    player.y += player.vy;
  }

  // Wrap-around
  if (player.x < -player.radius) player.x = canvas.width + player.radius;
  if (player.x > canvas.width + player.radius) player.x = -player.radius;
  if (player.y < -player.radius) player.y = canvas.height + player.radius;
  if (player.y > canvas.height + player.radius) player.y = -player.radius;

  // Lasers
  for (const l of lasers){
    if (l.vy !== undefined){
      l.y += l.vy;
      if (l.y + l.height > canvas.height || l.y < 0) l.vy *= -1;
    } else {
      l.x += l.vx;
      if (l.x + l.width > canvas.width || l.x < 0) l.vx *= -1;
    }
  }

  // Jump timer
  if (player.isJumping && Date.now() - player.jumpStartTime > player.jumpDuration){
    player.isJumping = false; player.color = 'blue';
  }

  checkCollisions();
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // Player
  ctx.fillStyle = player.color;
  ctx.beginPath(); ctx.arc(player.x,player.y,player.radius,0,Math.PI*2); ctx.fill();

  // Lasers
  for (const l of lasers){
    ctx.fillStyle = l.color;
    if (l.vy !== undefined) ctx.fillRect(0, l.y, canvas.width, l.height);
    else ctx.fillRect(l.x, 0, l.width, canvas.height);
  }

  // Coin
  ctx.fillStyle = coin.color;
  ctx.beginPath(); ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI*2); ctx.fill();

  // HUD
  ctx.fillStyle='#000'; ctx.font='18px Arial'; ctx.textAlign='left';
  ctx.fillText('Score: '+score, 10, 22);
}

/* Boot */
resetGame();
runCountdown();

/* Ensure the home joystick shows initially on mobile (bottom-right) */
if (isMobile) { placeHomeJoystick(); }
</script>
</body>
</html>
